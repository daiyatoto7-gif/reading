<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª­æ›¸ç®¡ç†ã‚¢ãƒ—ãƒª</title>

    <link rel="apple-touch-icon" href="hennsyuugo.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Theme Colors */
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            
            --primary-color: #38bdf8;
            --accent-color: #818cf8;
            --border-color: #334155;
            --input-bg: #020617;
            
            /* Status Colors */
            --status-unread: #64748b;
            --status-reading: #22c55e;
            --status-completed: #3b82f6;
            --status-dropped: #ef4444;

            --nav-height: 65px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: calc(var(--nav-height) + 20px);
            -webkit-font-smoothing: antialiased;
            /* iPhoneã®ãƒãƒƒãƒå¯¾å¿œãªã© */
            padding-top: env(safe-area-inset-top); 
        }

        h2 {
            font-size: 1.25rem;
            margin: 0 0 15px 0;
            font-weight: 700;
            color: var(--text-main);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        h3 {
            font-size: 1rem;
            margin: 0 0 10px 0;
            color: var(--text-sub);
            font-weight: 600;
        }

        /* Layout */
        .page {
            display: none;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        /* Forms */
        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 6px;
            margin-top: 15px;
        }
        label:first-child { margin-top: 0; }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-main);
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        textarea { resize: vertical; min-height: 80px; }

        /* Type Toggle (Radio-like buttons) */
        .type-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .type-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--text-sub);
            font-weight: bold;
        }
        .type-option.active {
            background: var(--primary-color);
            color: #0f172a;
            border-color: var(--primary-color);
        }

        /* Buttons */
        button {
            background-color: var(--primary-color);
            color: #0f172a;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s;
        }
        button:active { transform: scale(0.98); }
        button.secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
        }
        button.danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        /* Filter Buttons */
        .filter-group {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 10px;
            white-space: nowrap;
        }
        .filter-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            margin: 0;
            width: auto;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: #0f172a;
            border-color: var(--primary-color);
            font-weight: bold;
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1;
            text-align: center;
            font-size: 10px;
            color: var(--text-sub);
            cursor: pointer;
            padding: 5px;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .text-small { font-size: 0.8rem; color: var(--text-sub); }

        /* Book Item */
        .book-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .book-info { flex: 1; }
        .book-title { font-weight: bold; display: block; margin-bottom: 4px; }
        
        .status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
            vertical-align: middle;
            margin-left: 5px;
        }
        .type-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #475569;
            color: #fff;
            vertical-align: middle;
            margin-right: 5px;
        }
        .status-unread { background: var(--status-unread); }
        .status-reading { background: var(--status-reading); }
        .status-completed { background: var(--status-completed); }
        .status-dropped { background: var(--status-dropped); }

        /* Calendar */
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-month-title { font-weight: bold; font-size: 1.1rem; }
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;
            background-color: var(--border-color); border: 1px solid var(--border-color);
            border-radius: 8px; overflow: hidden;
        }
        .calendar-day-header { background-color: var(--card-bg); color: var(--text-sub); font-size: 10px; text-align: center; padding: 8px 0; }
        .calendar-cell { background-color: var(--card-bg); position: relative; height: 100px; overflow: hidden; }
        .day-number { position: absolute; top: 4px; left: 4px; font-size: 10px; color: var(--text-sub); z-index: 2; }
        .today .day-number { color: var(--primary-color); font-weight: bold; }
        .today { background-color: rgba(56, 189, 248, 0.05); }
        .event-bar {
            position: absolute; height: 16px; font-size: 9px; line-height: 16px;
            color: #1e293b; font-weight: 700; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; padding: 0 4px; z-index: 1;
            border-radius: 0; width: 100%; left: 0; margin: 0;
        }

        /* Charts & Stats */
        canvas { max-width: 100%; height: auto; margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .stat-item h3 { font-size: 0.8rem; margin-bottom: 0; }
        .stat-val { font-size: 1.2rem; font-weight: bold; }
        .stat-unit { font-size: 0.8rem; font-weight: normal; color: var(--text-sub); }

    </style>
</head>
<body>

    <div id="tab-record" class="page active">
        <h2>èª­æ›¸ã‚’è¨˜éŒ²</h2>
        <div class="card">
            <div class="flex">
                <button onclick="showRecordSection('add-new')">æ–°è¦è¿½åŠ </button>
                <button onclick="showRecordSection('log-reading')">è¨˜éŒ²ã™ã‚‹</button>
            </div>
            <button class="secondary" onclick="showRecordSection('change-status')">æœ¬ã®ç·¨é›†ãƒ»æ¤œç´¢</button>
        </div>

        <div id="section-add-new" class="card hidden">
            <h3>æ–°ã—ã„æœ¬ã‚’ç™»éŒ²</h3>
            
            <label>å½¢å¼</label>
            <div class="type-toggle">
                <div class="type-option active" id="type-opt-book" onclick="setNewBookType('book')">ğŸ“– èª­ã‚€</div>
                <div class="type-option" id="type-opt-audio" onclick="setNewBookType('audio')">ğŸ§ è´ã</div>
            </div>

            <label>ã‚¿ã‚¤ãƒˆãƒ« <span style="color:var(--status-dropped)">*</span></label>
            <input type="text" id="new-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
            
            <div id="new-input-book">
                <label>ãƒšãƒ¼ã‚¸æ•° (ä»»æ„ãƒ»é€²æ—ç”¨)</label>
                <input type="number" id="new-page" placeholder="ä¾‹: 0">
            </div>

            <div id="new-input-audio" class="hidden">
                <label>ç·å†ç”Ÿæ™‚é–“ (å¿…é ˆ)</label>
                <div class="flex">
                    <input type="number" id="new-total-h" placeholder="æ™‚é–“">
                    <input type="number" id="new-total-m" placeholder="åˆ†">
                </div>
            </div>

            <div class="flex">
                <div style="flex:1"><label>é–‹å§‹æ—¥</label><input type="date" id="new-start-date"></div>
                <div style="flex:1"><label>æœ¬æ—¥èª­ã‚“ã /è´ã„ãŸæ—¥</label><input type="date" id="new-log-date"></div>
            </div>
            
            <label>èª­äº†æ—¥ (æ—¢ã«çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆ)</label>
            <input type="date" id="new-finish-date">
            
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="new-memo" placeholder="æ„æ°—è¾¼ã¿ãªã©"></textarea>
            
            <button onclick="addNewBook()">è¿½åŠ ã™ã‚‹</button>
        </div>

        <div id="section-log-reading" class="card hidden">
            <h3>é€²æ—ã‚’è¨˜éŒ²</h3>
            <p class="text-small">èª­æ›¸ä¸­ãƒ»æœªèª­ã®ã¿è¡¨ç¤º</p>
            
            <label>æœ¬ã‚’é¸æŠ</label>
            <select id="log-book-select" onchange="updateLogInputMode()"></select>
            
            <p id="current-progress-display" style="color:var(--primary-color); font-weight:bold; font-size:12px; margin-top:5px; margin-bottom:15px;">
                ç¾åœ¨: -
            </p>

            <div id="log-input-container">
                </div>

            <label>æ—¥ä»˜</label>
            <input type="date" id="log-date">
            
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="log-memo" placeholder="æ„Ÿæƒ³ãªã©"></textarea>
            
            <button onclick="addLog()">è¨˜éŒ²ã‚’ä¿å­˜</button>
            <div class="flex" style="margin-top:15px;">
                <button class="secondary" onclick="finishBookFromLog()">èª­äº†ã«ã™ã‚‹</button>
                <button class="danger" onclick="dropBookFromLog()">é›¢è„±ã™ã‚‹</button>
            </div>
        </div>

        <div id="section-change-status" class="card hidden">
            <h3>æ¤œç´¢ãƒ»ç·¨é›†</h3>
            <input type="text" id="status-search" placeholder="ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢..." onkeyup="renderStatusList()">
            <div id="status-book-list" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="tab-bookshelf" class="page">
        <h2>æœ¬æ£š</h2>
        
        <div class="filter-group">
            <button id="filter-type-all" class="filter-btn active" onclick="setBookshelfTypeFilter('all')">å…¨å½¢å¼</button>
            <button id="filter-type-book" class="filter-btn" onclick="setBookshelfTypeFilter('book')">ğŸ“– èª­ã‚€</button>
            <button id="filter-type-audio" class="filter-btn" onclick="setBookshelfTypeFilter('audio')">ğŸ§ è´ã</button>
        </div>

        <div class="filter-group">
            <button id="filter-status-reading" class="filter-btn active" onclick="setBookshelfStatusFilter('reading')">èª­æ›¸ä¸­</button>
            <button id="filter-status-all" class="filter-btn" onclick="setBookshelfStatusFilter('all')">ã™ã¹ã¦</button>
            <button id="filter-status-unread" class="filter-btn" onclick="setBookshelfStatusFilter('unread')">æœªèª­</button>
            <button id="filter-status-completed" class="filter-btn" onclick="setBookshelfStatusFilter('completed')">èª­äº†</button>
            <button id="filter-status-dropped" class="filter-btn" onclick="setBookshelfStatusFilter('dropped')">é›¢è„±</button>
        </div>

        <div id="bookshelf-list" class="card" style="min-height:200px"></div>
    </div>

    <div id="edit-screen" class="page">
        <button class="secondary" onclick="closeEditScreen()" style="width:auto; margin-bottom:15px;">â† æˆ»ã‚‹</button>
        <h2>è©³ç´°ç·¨é›†</h2>
        <div class="card">
            <input type="hidden" id="edit-id">
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="edit-title">
            
            <label>å½¢å¼ (å¤‰æ›´ä¸å¯)</label>
            <div id="edit-type-display" style="padding:10px; background:var(--input-bg); border-radius:8px; color:var(--text-sub);"></div>

            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="edit-status">
                <option value="unread">æœªèª­</option>
                <option value="reading">èª­æ›¸ä¸­</option>
                <option value="completed">èª­äº†</option>
                <option value="dropped">é›¢è„±ä¸­</option>
            </select>

            <div class="flex">
                <div style="flex:1"><label>é–‹å§‹æ—¥</label><input type="date" id="edit-start-date"></div>
                <div style="flex:1"><label>çµ‚äº†æ—¥</label><input type="date" id="edit-finish-date"></div>
            </div>

            <label id="edit-current-label">æœ€æ–°ã®é€²æ—</label>
            <input type="number" id="edit-current-value">
            
            <h3 style="margin-top:20px;">å±¥æ­´</h3>
            <div id="edit-memo-history" class="memo-history" style="background:var(--input-bg); padding:10px; border-radius:8px; max-height:150px; overflow-y:auto;"></div>
            
            <button onclick="saveEdit()" style="margin-top:20px;">ä¿å­˜</button>
            <button class="danger" onclick="deleteBook()">å‰Šé™¤</button>
        </div>
    </div>

    <div id="tab-calendar" class="page">
        <h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div class="card" style="padding:10px;">
            <div class="calendar-header">
                <button class="secondary" style="width:40px; margin:0;" onclick="changeMonth(-1)">â€¹</button>
                <span id="calendar-title" class="calendar-month-title"></span>
                <button class="secondary" style="width:40px; margin:0;" onclick="changeMonth(1)">â€º</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="tab-stats" class="page">
        <h2>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</h2>
        
        <div class="card">
            <h3>å…¨ä½“</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <span id="stat-total-completed" class="stat-val">0</span> <span class="stat-unit">å†Š (èª­äº†)</span>
                </div>
                <div class="stat-item">
                    <span id="stat-avg-days-book" class="stat-val">0</span> <span class="stat-unit">æ—¥/å†Š (å¹³å‡)</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“– èª­ã‚€ (ãƒšãƒ¼ã‚¸)</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <span id="stat-total-pages" class="stat-val" style="color:var(--primary-color)">0</span> <span class="stat-unit">p (ç´¯è¨ˆ)</span>
                </div>
                <div class="stat-item">
                    <span id="stat-avg-daily-page" class="stat-val" style="color:var(--primary-color)">0</span> <span class="stat-unit">p/æ—¥ (å¹³å‡)</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ§ è´ã (æ™‚é–“)</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <span id="stat-total-time" class="stat-val" style="color:var(--accent-color)">0</span> <span class="stat-unit">æ™‚é–“ (ç´¯è¨ˆ)</span>
                </div>
                <div class="stat-item">
                    <span id="stat-avg-daily-time" class="stat-val" style="color:var(--accent-color)">0</span> <span class="stat-unit">åˆ†/æ—¥ (å¹³å‡)</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>æœˆåˆ¥èª­äº†æ•° (åˆç®—)</h3>
            <canvas id="chart-monthly-completed"></canvas>
        </div>

        <div class="card">
            <h3>ğŸ“– æ—¥åˆ¥ ãƒšãƒ¼ã‚¸æ•° (ç›´è¿‘7æ—¥)</h3>
            <canvas id="chart-daily-pages"></canvas>
        </div>

        <div class="card">
            <h3>ğŸ§ æ—¥åˆ¥ å†ç”Ÿæ™‚é–“ (ç›´è¿‘7æ—¥)</h3>
            <canvas id="chart-daily-time"></canvas>
        </div>
        <div class="card">
            <h3>ğŸ§ é€±åˆ¥ å†ç”Ÿæ™‚é–“</h3>
            <canvas id="chart-weekly-time"></canvas>
        </div>
        <div class="card">
            <h3>ğŸ§ æœˆåˆ¥ å†ç”Ÿæ™‚é–“</h3>
            <canvas id="chart-monthly-time"></canvas>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('record')"><span class="nav-icon">âœ</span> è¨˜éŒ²</div>
        <div class="nav-item" onclick="switchTab('bookshelf')"><span class="nav-icon">ğŸ“š</span> æœ¬æ£š</div>
        <div class="nav-item" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
        <div class="nav-item" onclick="switchTab('stats')"><span class="nav-icon">ğŸ“Š</span> çµ±è¨ˆ</div>
    </div>

    <script>
        // --- Data & Init ---
        // Book Structure: { id, title, type:'book'|'audio', status, startDate, finishDate, totalMinutes(audio only), logs:[{date, value, memo}] }
        let books = JSON.parse(localStorage.getItem('readingApp_books')) || [];
        let currentCalendarDate = new Date();
        let newBookType = 'book';
        let bookshelfTypeFilter = 'all';
        let bookshelfStatusFilter = 'reading';

        const colorPalette = ['#fca5a5', '#fdba74', '#fde047', '#86efac', '#67e8f9', '#93c5fd', '#c4b5fd', '#f0abfc'];
        function getBookColor(id) { return colorPalette[id % colorPalette.length]; }
        function saveData() { localStorage.setItem('readingApp_books', JSON.stringify(books)); }

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';

        // --- Tabs ---
        function switchTab(tabName) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const map = { record:0, bookshelf:1, calendar:2, stats:3 };
            if(map[tabName]!==undefined) document.querySelectorAll('.nav-item')[map[tabName]].classList.add('active');
            
            if(tabName==='record') resetRecordForms();
            if(tabName==='bookshelf') renderBookshelf();
            if(tabName==='calendar') renderCalendar();
            if(tabName==='stats') renderStats();
            window.scrollTo(0,0);
        }

        // --- Record Logic ---
        function showRecordSection(section) {
            ['add-new','log-reading','change-status'].forEach(s=>document.getElementById(`section-${s}`).classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');
            if(section==='log-reading') populateLogSelect();
            if(section==='change-status') renderStatusList();
        }

        function resetRecordForms() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-log-date').value = today;
            document.getElementById('log-date').value = today;
            setNewBookType('book');
        }

        function setNewBookType(type) {
            newBookType = type;
            document.getElementById('type-opt-book').classList.toggle('active', type==='book');
            document.getElementById('type-opt-audio').classList.toggle('active', type==='audio');
            if(type==='book') {
                document.getElementById('new-input-book').classList.remove('hidden');
                document.getElementById('new-input-audio').classList.add('hidden');
            } else {
                document.getElementById('new-input-book').classList.add('hidden');
                document.getElementById('new-input-audio').classList.remove('hidden');
            }
        }

        function addNewBook() {
            const title = document.getElementById('new-title').value;
            if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            const startDate = document.getElementById('new-start-date').value;
            const logDate = document.getElementById('new-log-date').value;
            const finishDate = document.getElementById('new-finish-date').value;
            const memo = document.getElementById('new-memo').value;

            let totalMinutes = 0;
            let initialValue = 0; // Page or Minutes read

            if(newBookType === 'audio') {
                const h = parseInt(document.getElementById('new-total-h').value) || 0;
                const m = parseInt(document.getElementById('new-total-m').value) || 0;
                totalMinutes = h * 60 + m;
                if(totalMinutes <= 0) return alert("ç·å†ç”Ÿæ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                // For audio, initial value is implied 0 unless logged later
            } else {
                initialValue = parseInt(document.getElementById('new-page').value) || 0;
            }

            const newBook = {
                id: Date.now(),
                title: title,
                type: newBookType,
                status: 'unread',
                startDate: startDate || '',
                finishDate: finishDate || '',
                totalMinutes: totalMinutes, // Only relevant for audio
                logs: []
            };

            // If initial value logged (Page or Started Audio)
            // For Audio in Add New: we don't have "Remaining" input UI, so assume 0 unless we add logic.
            // Keeping it simple: Add book first, then log progress for audio if needed. 
            // BUT if it is 'book' and page > 0, log it.
            if(newBookType === 'book' && (initialValue > 0 || logDate)) {
                newBook.status = 'reading';
                if(!newBook.startDate && logDate) newBook.startDate = logDate;
                if(finishDate) newBook.status = 'completed';
                newBook.logs.push({ date: logDate || new Date().toISOString().split('T')[0], value: initialValue, memo: memo });
            } 
            // If Audio and just adding, user can log progress in next step.

            books.push(newBook);
            saveData();
            alert(`ã€Œ${title}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            
            // Clean up
            document.getElementById('new-title').value = '';
            document.getElementById('new-page').value = '';
            document.getElementById('new-memo').value = '';
            document.getElementById('new-total-h').value = '';
            document.getElementById('new-total-m').value = '';
            showRecordSection('log-reading');
        }

        // --- Log Reading Logic ---
        function populateLogSelect() {
            const select = document.getElementById('log-book-select');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            books.filter(b => b.status === 'unread' || b.status === 'reading').forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = `${b.type==='audio'?'ğŸ§':'ğŸ“–'} ${b.title}`;
                select.appendChild(opt);
            });
            updateLogInputMode();
        }

        function updateLogInputMode() {
            const id = document.getElementById('log-book-select').value;
            const container = document.getElementById('log-input-container');
            const disp = document.getElementById('current-progress-display');
            container.innerHTML = '';
            
            if(!id) { disp.innerText = "ç¾åœ¨: -"; return; }
            
            const b = books.find(x => x.id == id);
            const lastVal = b.logs.length ? b.logs[b.logs.length-1].value : 0;

            if(b.type === 'book') {
                disp.innerText = `ç¾åœ¨: ${lastVal} ãƒšãƒ¼ã‚¸`;
                container.innerHTML = `
                    <div class="flex">
                        <div style="flex:1"><label>èª­ã‚“ã ãƒšãƒ¼ã‚¸æ•° (ç´¯ç©)</label><input type="number" id="log-val-page" placeholder="ä¾‹: 120"></div>
                    </div>`;
            } else {
                // Audio
                const doneM = lastVal;
                const doneH = Math.floor(doneM / 60);
                const doneMin = doneM % 60;
                
                // Calculate remaining for hint
                const remainM = b.totalMinutes - doneM;
                const remH = Math.floor(remainM / 60);
                const remMin = remainM % 60;

                disp.innerText = `ç¾åœ¨: ${doneH}æ™‚é–“${doneMin}åˆ† å†ç”Ÿæ¸ˆ (æ®‹ã‚Šç´„ ${remH}æ™‚é–“${remMin}åˆ†)`;
                
                container.innerHTML = `
                    <label>ã‚¢ãƒ—ãƒªä¸Šã®ã€Œæ®‹ã‚Šæ™‚é–“ã€ã‚’å…¥åŠ›</label>
                    <div class="flex">
                        <div style="flex:1"><input type="number" id="log-rem-h" placeholder="æ®‹ã‚Šæ™‚é–“"></div>
                        <div style="flex:1"><input type="number" id="log-rem-m" placeholder="æ®‹ã‚Šåˆ†"></div>
                    </div>`;
            }
        }

        function addLog() {
            const id = document.getElementById('log-book-select').value;
            if(!id) return alert("æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            const date = document.getElementById('log-date').value;
            const memo = document.getElementById('log-memo').value;
            const b = books.find(x => x.id == id);

            let newValue = 0;

            if(b.type === 'book') {
                newValue = parseInt(document.getElementById('log-val-page').value);
                if(isNaN(newValue)) return alert("ãƒšãƒ¼ã‚¸æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                const lastVal = b.logs.length ? b.logs[b.logs.length-1].value : 0;
                if(newValue < lastVal) return alert("ãƒšãƒ¼ã‚¸æ•°ãŒæ¸›ã£ã¦ã„ã¾ã™");
            } else {
                // Audio: Calculate progress from Remaining Time
                const h = parseInt(document.getElementById('log-rem-h').value) || 0;
                const m = parseInt(document.getElementById('log-rem-m').value) || 0;
                const remainMinutes = h * 60 + m;
                
                // Logic: Done = Total - Remain
                newValue = b.totalMinutes - remainMinutes;
                
                if(newValue < 0) newValue = 0; // Should not happen unless Total is wrong
                if(newValue > b.totalMinutes) newValue = b.totalMinutes; // Cap at max
                
                const lastVal = b.logs.length ? b.logs[b.logs.length-1].value : 0;
                // Allow correction but warn? For now assume valid input.
            }

            if(b.status === 'unread') {
                b.status = 'reading';
                if(!b.startDate) b.startDate = date;
            }

            b.logs.push({ date, value: newValue, memo });
            b.logs.sort((x,y) => new Date(x.date) - new Date(y.date));
            saveData();
            alert("è¨˜éŒ²ã—ã¾ã—ãŸ");
            document.getElementById('log-memo').value = '';
            updateLogInputMode();
        }

        function finishBookFromLog() {
            const id = document.getElementById('log-book-select').value;
            if(!id) return;
            const b = books.find(x => x.id == id);
            b.status = 'completed';
            b.finishDate = document.getElementById('log-date').value || new Date().toISOString().split('T')[0];
            // If Audio, set progress to total
            if(b.type === 'audio') {
                b.logs.push({date: b.finishDate, value: b.totalMinutes, memo: 'èª­äº†'});
            }
            saveData();
            alert("èª­äº†ã«ã—ã¾ã—ãŸ");
            populateLogSelect();
        }

        function dropBookFromLog() {
            const id = document.getElementById('log-book-select').value;
            if(!id) return;
            books.find(x => x.id == id).status = 'dropped';
            saveData();
            alert("é›¢è„±ã«ã—ã¾ã—ãŸ");
            populateLogSelect();
        }

        // --- Bookshelf & Filters ---
        function setBookshelfTypeFilter(t) {
            bookshelfTypeFilter = t;
            ['all','book','audio'].forEach(k => {
                document.getElementById(`filter-type-${k}`).classList.toggle('active', k===t);
            });
            renderBookshelf();
        }

        function setBookshelfStatusFilter(s) {
            bookshelfStatusFilter = s;
            ['reading','all','unread','completed','dropped'].forEach(k => {
                document.getElementById(`filter-status-${k}`).classList.toggle('active', k===s);
            });
            renderBookshelf();
        }

        function renderBookshelf() {
            const list = document.getElementById('bookshelf-list');
            list.innerHTML = '';
            
            let targets = books;
            // Apply Status Filter
            if(bookshelfStatusFilter !== 'all') {
                targets = targets.filter(b => b.status === bookshelfStatusFilter);
            }
            // Apply Type Filter
            if(bookshelfTypeFilter !== 'all') {
                targets = targets.filter(b => b.type === bookshelfTypeFilter);
            }

            if(targets.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub);">æœ¬ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            targets.forEach(b => {
                const item = document.createElement('div');
                item.className = 'book-item';
                
                const typeIcon = b.type==='audio' ? 'ğŸ§' : 'ğŸ“–';
                const statusLabel = { unread:'æœªèª­', reading:'èª­æ›¸ä¸­', completed:'èª­äº†', dropped:'é›¢è„±' }[b.status];
                
                // Progress Text
                let progText = "";
                const lastVal = b.logs.length ? b.logs[b.logs.length-1].value : 0;
                if(b.type === 'book') {
                    progText = `${lastVal} p`;
                } else {
                    const h = Math.floor(lastVal/60);
                    const m = lastVal%60;
                    progText = `${h}æ™‚é–“${m}åˆ†`;
                }

                item.innerHTML = `
                    <div class="book-info">
                        <span class="book-title">
                            <span class="type-badge">${typeIcon}</span>
                            ${b.title} 
                            <span class="status-badge status-${b.status}">${statusLabel}</span>
                        </span>
                        <div class="text-small">
                            é€²æ—: ${progText} <br>
                            æœŸé–“: ${b.startDate||'-'} ~ ${b.finishDate||'-'}
                        </div>
                    </div>
                    <button class="secondary" style="width:auto; margin:0;" onclick="openEditScreen(${b.id})">è©³ç´°</button>
                `;
                list.appendChild(item);
            });
        }

        function renderStatusList() {
            const list = document.getElementById('status-book-list');
            const q = document.getElementById('status-search').value.toLowerCase();
            list.innerHTML = '';
            books.filter(b => b.title.toLowerCase().includes(q)).forEach(b => {
                const item = document.createElement('div');
                item.className = 'book-item';
                const typeIcon = b.type==='audio' ? 'ğŸ§' : 'ğŸ“–';
                item.innerHTML = `
                    <div class="book-info">
                        <span class="book-title"><span class="type-badge">${typeIcon}</span> ${b.title}</span>
                    </div>
                    <button class="secondary" style="width:auto; padding:6px 12px; font-size:12px; margin:0;" onclick="openEditScreen(${b.id})">ç·¨é›†</button>
                `;
                list.appendChild(item);
            });
        }

        // --- Edit Screen ---
        function openEditScreen(id) {
            const b = books.find(x => x.id == id);
            if(!b) return;
            document.getElementById('edit-id').value = b.id;
            document.getElementById('edit-title').value = b.title;
            document.getElementById('edit-status').value = b.status;
            document.getElementById('edit-start-date').value = b.startDate;
            document.getElementById('edit-finish-date').value = b.finishDate;
            
            document.getElementById('edit-type-display').innerText = b.type==='audio' ? 'ğŸ§ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ–ãƒƒã‚¯' : 'ğŸ“– æ›¸ç±';
            document.getElementById('edit-current-label').innerText = b.type==='audio' ? 'æœ€æ–°ã®å†ç”Ÿæ¸ˆæ™‚é–“(åˆ†)' : 'æœ€æ–°ã®åˆ°é”ãƒšãƒ¼ã‚¸';
            
            const lastVal = b.logs.length ? b.logs[b.logs.length-1].value : 0;
            document.getElementById('edit-current-value').value = lastVal;

            const hist = document.getElementById('edit-memo-history');
            hist.innerHTML = '';
            [...b.logs].sort((x,y) => new Date(y.date)-new Date(x.date)).forEach(l => {
                const d = document.createElement('div');
                d.className = 'memo-item';
                const valStr = b.type==='audio' ? `${l.value}åˆ†` : `${l.value}p`;
                d.innerHTML = `<span style="color:var(--primary-color); font-weight:bold;">${l.date}</span> (${valStr}) ${l.memo ? '<br>'+l.memo : ''}`;
                hist.appendChild(d);
            });

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('edit-screen').classList.add('active');
        }

        function closeEditScreen() {
            document.getElementById('edit-screen').classList.remove('active');
            switchTab('bookshelf');
        }

        function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const b = books.find(x => x.id == id);
            b.title = document.getElementById('edit-title').value;
            b.status = document.getElementById('edit-status').value;
            b.startDate = document.getElementById('edit-start-date').value;
            b.finishDate = document.getElementById('edit-finish-date').value;
            
            const inpVal = parseInt(document.getElementById('edit-current-value').value);
            const lastLog = b.logs.length ? b.logs[b.logs.length-1] : null;
            if(!lastLog || lastLog.value !== inpVal) {
                b.logs.push({ date: new Date().toISOString().split('T')[0], value: inpVal, memo: 'ç·¨é›†ç”»é¢æ›´æ–°' });
                b.logs.sort((x,y) => new Date(x.date)-new Date(y.date));
            }
            saveData();
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            closeEditScreen();
        }

        function deleteBook() {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const id = document.getElementById('edit-id').value;
            books = books.filter(b => b.id != id);
            saveData();
            closeEditScreen();
        }

        // --- Calendar (unchanged logic) ---
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendar-title').innerText = `${year}å¹´ ${month+1}æœˆ`;
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
                const div = document.createElement('div'); div.className='calendar-day-header'; div.innerText=d; grid.appendChild(div);
            });
            const first = new Date(year, month, 1);
            const last = new Date(year, month+1, 0);
            const startIdx = first.getDay();
            const total = last.getDate();
            
            let days = [];
            for(let i=0; i<startIdx; i++) days.push(null);
            for(let i=1; i<=total; i++) days.push(new Date(year, month, i));

            for(let i=0; i<days.length; i+=7) {
                const week = days.slice(i, i+7);
                let activeSet = new Set();
                week.forEach(d => {
                    if(d) {
                        books.forEach(b => {
                            if(b.status==='dropped' || !b.startDate) return;
                            const s = new Date(b.startDate); s.setHours(0,0,0,0);
                            let e = b.finishDate ? new Date(b.finishDate) : new Date(); e.setHours(0,0,0,0);
                            const c = d; c.setHours(0,0,0,0);
                            if(c >= s && c <= e) activeSet.add(b);
                        });
                    }
                });
                const sorted = Array.from(activeSet).sort((a,b) => (new Date(a.startDate)-new Date(b.startDate)) || (a.id-b.id));
                const slotMap = {};
                sorted.forEach((b, idx) => slotMap[b.id] = idx);

                for(let j=0; j<7; j++) {
                    const d = week[j];
                    const cell = document.createElement('div'); cell.className='calendar-cell';
                    if(d) {
                        const todayStr = new Date().toISOString().split('T')[0];
                        if(d.toISOString().split('T')[0] === todayStr) cell.classList.add('today');
                        cell.innerHTML = `<span class="day-number">${d.getDate()}</span>`;
                        
                        const dayStart = new Date(d); dayStart.setHours(0,0,0,0);
                        sorted.filter(b => {
                            const s = new Date(b.startDate); s.setHours(0,0,0,0);
                            let e = b.finishDate ? new Date(b.finishDate) : new Date(); e.setHours(0,0,0,0);
                            return dayStart >= s && dayStart <= e;
                        }).forEach(b => {
                            const slot = slotMap[b.id];
                            const top = 20 + (slot*18);
                            const bar = document.createElement('div');
                            bar.className = 'event-bar';
                            bar.style.top = `${top}px`;
                            bar.style.backgroundColor = getBookColor(b.id);
                            
                            const s = new Date(b.startDate); s.setHours(0,0,0,0);
                            let e = b.finishDate ? new Date(b.finishDate) : new Date(); e.setHours(0,0,0,0);
                            
                            if(j===0 || dayStart.getTime()===s.getTime()) {
                                const icon = b.type==='audio' ? 'ğŸ§ ' : '';
                                bar.innerText = icon + b.title;
                            } else { bar.innerHTML='&nbsp;'; }

                            if(dayStart.getTime()===s.getTime()) {
                                bar.style.borderTopLeftRadius='4px'; bar.style.borderBottomLeftRadius='4px';
                                bar.style.marginLeft='2px'; bar.style.width='calc(100% - 2px)';
                            }
                            if(dayStart.getTime()===e.getTime()) {
                                bar.style.borderTopRightRadius='4px'; bar.style.borderBottomRightRadius='4px';
                                bar.style.marginRight='2px';
                                bar.style.width = (dayStart.getTime()===s.getTime()) ? 'calc(100% - 4px)' : 'calc(100% - 2px)';
                            }
                            cell.appendChild(bar);
                        });
                    } else { cell.style.background='transparent'; }
                    grid.appendChild(cell);
                }
            }
        }

        // --- Stats Logic ---
        let charts = {};
        function renderStats() {
            const completed = books.filter(b => b.status === 'completed');
            
            // 1. General (All types)
            document.getElementById('stat-total-completed').innerText = completed.length;
            let totalDays = 0;
            completed.forEach(b => {
                const s = new Date(b.startDate); const e = new Date(b.finishDate);
                totalDays += Math.max(1, Math.ceil((e-s)/86400000)+1);
            });
            document.getElementById('stat-avg-days-book').innerText = completed.length ? Math.round(totalDays/completed.length) : 0;

            // 2. Books (Pages)
            const bookOnly = books.filter(b => b.type === 'book');
            let totalPages = 0;
            let allBookDates = new Set();
            bookOnly.forEach(b => {
                if(b.logs.length) totalPages += Math.max(...b.logs.map(l=>l.value));
                b.logs.forEach(l => allBookDates.add(l.date));
            });
            document.getElementById('stat-total-pages').innerText = totalPages;
            
            // Avg Daily Page (from first book log)
            let avgDailyP = 0;
            if(allBookDates.size > 0) {
                 const minD = new Date(Math.min(...Array.from(allBookDates).map(d=>new Date(d))));
                 const diff = Math.max(1, Math.ceil((new Date() - minD)/86400000));
                 avgDailyP = Math.round(totalPages / diff);
            }
            document.getElementById('stat-avg-daily-page').innerText = avgDailyP;

            // 3. Audio (Time)
            const audioOnly = books.filter(b => b.type === 'audio');
            let totalMins = 0;
            let allAudioDates = new Set();
            // Calculate actual listened minutes (delta)
            let dailyTimeMap = {};
            audioOnly.forEach(b => {
                let sLogs = [...b.logs].sort((x,y) => new Date(x.date)-new Date(y.date));
                sLogs.forEach((l,i) => {
                    const prev = i>0 ? sLogs[i-1].value : 0;
                    const d = l.value - prev;
                    if(d>0) {
                        totalMins += d;
                        dailyTimeMap[l.date] = (dailyTimeMap[l.date]||0) + d;
                        allAudioDates.add(l.date);
                    }
                });
            });
            const totalH = (totalMins/60).toFixed(1);
            document.getElementById('stat-total-time').innerText = totalH;

            // Avg Daily Time
            let avgDailyMin = 0;
            if(allAudioDates.size > 0) {
                const minD = new Date(Math.min(...Array.from(allAudioDates).map(d=>new Date(d))));
                const diff = Math.max(1, Math.ceil((new Date() - minD)/86400000));
                avgDailyMin = Math.round(totalMins / diff);
            }
            document.getElementById('stat-avg-daily-time').innerText = avgDailyMin;

            // --- Charts Data Prep ---
            // A. Monthly Completed (Mixed)
            const mComp = {};
            completed.forEach(b => {
                if(b.finishDate) mComp[b.finishDate.slice(0,7)] = (mComp[b.finishDate.slice(0,7)]||0)+1;
            });
            drawChart('chart-monthly-completed', 'line', mComp, 'èª­äº†æ•°', '#3b82f6');

            // B. Daily Pages (Book Only) - Delta
            let dailyPageMap = {};
            bookOnly.forEach(b => {
                let sLogs = [...b.logs].sort((x,y) => new Date(x.date)-new Date(y.date));
                sLogs.forEach((l,i) => {
                    const prev = i>0 ? sLogs[i-1].value : 0;
                    const d = l.value - prev;
                    if(d>0) dailyPageMap[l.date] = (dailyPageMap[l.date]||0) + d;
                });
            });
            drawChartLast7('chart-daily-pages', dailyPageMap, 'ãƒšãƒ¼ã‚¸', '#38bdf8');

            // C. Daily Time (Audio Only)
            drawChartLast7('chart-daily-time', dailyTimeMap, 'åˆ†', '#818cf8');

            // D. Weekly Time (Audio Only)
            const weeklyTime = {};
            Object.keys(dailyTimeMap).sort().forEach(k => {
                const d = new Date(k);
                const day = d.getDay()||7; 
                if(day!==1) d.setHours(-24*(day-1));
                const wKey = d.toISOString().split('T')[0];
                weeklyTime[wKey] = (weeklyTime[wKey]||0) + dailyTimeMap[k];
            });
            // Convert to hours for chart
            const weeklyTimeH = {};
            Object.keys(weeklyTime).forEach(k => weeklyTimeH[k] = (weeklyTime[k]/60).toFixed(1));
            drawChart('chart-weekly-time', 'line', weeklyTimeH, 'æ™‚é–“', '#a78bfa');

            // E. Monthly Time (Audio Only)
            const monthlyTime = {};
            Object.keys(dailyTimeMap).forEach(k => {
                const mKey = k.slice(0,7);
                monthlyTime[mKey] = (monthlyTime[mKey]||0) + dailyTimeMap[k];
            });
            const monthlyTimeH = {};
            Object.keys(monthlyTime).forEach(k => monthlyTimeH[k] = (monthlyTime[k]/60).toFixed(1));
            drawChart('chart-monthly-time', 'bar', monthlyTimeH, 'æ™‚é–“', '#f472b6');
        }

        function drawChartLast7(id, dataMap, label, color) {
            const last7 = {};
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                const k = d.toISOString().split('T')[0];
                last7[k.slice(5)] = dataMap[k]||0;
            }
            drawChartRaw(id, 'bar', Object.keys(last7), Object.values(last7), label, color);
        }

        function drawChart(id, type, dataObj, label, color) {
            const keys = Object.keys(dataObj).sort();
            const useKeys = keys.slice(-12); // Last 12 points
            const useVals = useKeys.map(k => dataObj[k]);
            drawChartRaw(id, type, useKeys, useVals, label, color);
        }

        function drawChartRaw(id, type, labels, data, label, color) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            
            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        tension: 0.3,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' } },
                        x: { grid: { display: false } }
                    }
                }
            };
            if(type==='line') {
                config.data.datasets[0].backgroundColor = color+'20';
                config.data.datasets[0].fill = true;
            }
            charts[id] = new Chart(ctx, config);
        }

        // Init
        resetRecordForms();
        renderBookshelf(); // Default view
    </script>
</body>
</html>

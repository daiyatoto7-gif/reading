<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èª­æ›¸ç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Modern Dark Theme Palette */
            --bg-color: #0f172a;       /* Very dark slate */
            --card-bg: #1e293b;        /* Slate 800 */
            --card-bg-hover: #334155;
            --text-main: #f1f5f9;      /* Slate 100 */
            --text-sub: #94a3b8;       /* Slate 400 */
            
            --primary-color: #38bdf8;  /* Sky 400 */
            --primary-hover: #0ea5e9;
            --accent-color: #818cf8;   /* Indigo 400 */
            
            --border-color: #334155;
            --input-bg: #020617;
            
            /* Status Colors (Pastel/Muted) */
            --status-unread: #64748b;
            --status-reading: #22c55e;
            --status-completed: #3b82f6;
            --status-dropped: #ef4444;

            --nav-height: 65px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: calc(var(--nav-height) + 20px);
            -webkit-font-smoothing: antialiased;
        }

        h2 {
            font-size: 1.25rem;
            margin: 0 0 15px 0;
            font-weight: 700;
            color: var(--text-main);
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        h3 {
            font-size: 1rem;
            margin: 0 0 10px 0;
            color: var(--text-sub);
            font-weight: 600;
        }

        /* Layout */
        .page {
            display: none;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        /* Forms */
        label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-bottom: 6px;
            margin-top: 15px;
        }
        label:first-child { margin-top: 0; }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-main);
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        textarea { resize: vertical; min-height: 80px; }

        /* Buttons */
        button {
            background-color: var(--primary-color);
            color: #0f172a;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s;
        }
        button:active { transform: scale(0.98); }
        button.secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
        }
        
        /* Filter Buttons (Bookshelf) */
        .filter-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-sub);
            margin: 0;
            width: auto;
            padding: 8px 15px;
            border-radius: 20px; /* Pill shape */
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .filter-btn.active {
            background-color: var(--primary-color);
            color: #0f172a;
            border-color: var(--primary-color);
            font-weight: bold;
        }

        button.danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1;
            text-align: center;
            font-size: 10px;
            color: var(--text-sub);
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--primary-color);
        }
        .nav-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 2px;
        }

        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 10px; }
        .text-small { font-size: 0.8rem; color: var(--text-sub); }

        /* Book Item List */
        .book-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .book-item:last-child { border-bottom: none; }
        .book-info { flex: 1; }
        .book-title { font-weight: bold; display: block; margin-bottom: 4px; }
        
        .status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            color: #fff;
            vertical-align: middle;
            margin-left: 5px;
        }
        .status-unread { background: var(--status-unread); }
        .status-reading { background: var(--status-reading); }
        .status-completed { background: var(--status-completed); }
        .status-dropped { background: var(--status-dropped); }

        /* --- Calendar Styles --- */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-month-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background-color: var(--card-bg);
            color: var(--text-sub);
            font-size: 10px;
            text-align: center;
            padding: 8px 0;
        }

        .calendar-cell {
            background-color: var(--card-bg);
            position: relative;
            height: 100px;
            overflow: hidden; 
            /* No padding to ensure bars touch edges */
        }
        
        .day-number {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 10px;
            color: var(--text-sub);
            z-index: 2;
        }
        .today .day-number {
            color: var(--primary-color);
            font-weight: bold;
        }
        .today {
            background-color: rgba(56, 189, 248, 0.05);
        }

        /* Event Bars Logic */
        .event-bar {
            position: absolute;
            height: 16px;
            font-size: 9px;
            line-height: 16px;
            color: #1e293b; 
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 4px;
            z-index: 1;
            
            /* RESET visual breaks for continuity */
            border-radius: 0;
            box-shadow: none;
            width: 100%; 
            left: 0;
            margin: 0;
        }
        
        /* Charts */
        canvas { max-width: 100%; height: auto; }
        
        /* Memo History */
        .memo-history {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .memo-item {
            font-size: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>
<body>

    <div id="tab-record" class="page active">
        <h2>èª­æ›¸ã‚’è¨˜éŒ²</h2>
        <div class="card">
            <h3>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
            <div class="flex">
                <button onclick="showRecordSection('add-new')">æ–°è¦è¿½åŠ </button>
                <button onclick="showRecordSection('log-reading')">è¨˜éŒ²ã™ã‚‹</button>
            </div>
            <button class="secondary" onclick="showRecordSection('change-status')">æœ¬ã®ç·¨é›†ãƒ»æ¤œç´¢</button>
        </div>

        <div id="section-add-new" class="card hidden">
            <h3>æ–°ã—ã„æœ¬ã‚’ç™»éŒ²</h3>
            <label>ã‚¿ã‚¤ãƒˆãƒ« <span style="color:var(--status-dropped)">*</span></label>
            <input type="text" id="new-title" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›">
            <div class="flex">
                <div style="flex:1">
                    <label>é–‹å§‹æ—¥ (è‡ªå‹•)</label>
                    <input type="date" id="new-start-date">
                </div>
                <div style="flex:1">
                    <label>èª­æ›¸æ—¥ (ä»»æ„)</label>
                    <input type="date" id="new-log-date">
                </div>
            </div>
            <label>èª­ã‚“ã ãƒšãƒ¼ã‚¸æ•°</label>
            <input type="number" id="new-page" placeholder="ä¾‹: 0">
            <label>èª­äº†æ—¥ (èª­ã¿çµ‚ã‚ã£ãŸå ´åˆ)</label>
            <input type="date" id="new-finish-date">
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="new-memo" placeholder="æ„æ°—è¾¼ã¿ã‚„æ„Ÿæƒ³ãªã©"></textarea>
            <button onclick="addNewBook()">è¿½åŠ ã™ã‚‹</button>
        </div>

        <div id="section-log-reading" class="card hidden">
            <h3>é€²æ—ã‚’è¨˜éŒ²</h3>
            <p class="text-small" style="margin-bottom:10px">èª­æ›¸ä¸­ã¾ãŸã¯æœªèª­ã®æœ¬ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            <label>æœ¬ã‚’é¸æŠ</label>
            <select id="log-book-select" onchange="updateCurrentPageDisplay()"></select>
            <p id="current-page-display" style="color:var(--primary-color); font-weight:bold; font-size:12px; margin-top:5px;">ç¾åœ¨: - ãƒšãƒ¼ã‚¸</p>
            <div class="flex">
                <div style="flex:1">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="log-date">
                </div>
                <div style="flex:1">
                    <label>ãƒšãƒ¼ã‚¸æ•°</label>
                    <input type="number" id="log-page">
                </div>
            </div>
            <label>ãƒ¡ãƒ¢</label>
            <textarea id="log-memo" placeholder="æ°—ã«ãªã£ãŸã“ã¨ã€æ„Ÿæƒ³"></textarea>
            <button onclick="addLog()">è¨˜éŒ²ã‚’ä¿å­˜</button>
            <div class="flex" style="margin-top:15px;">
                <button class="secondary" onclick="finishBookFromLog()">èª­äº†ã«ã™ã‚‹</button>
                <button class="danger" onclick="dropBookFromLog()">é›¢è„±ã™ã‚‹</button>
            </div>
        </div>

        <div id="section-change-status" class="card hidden">
            <h3>æ¤œç´¢ãƒ»ç·¨é›†</h3>
            <input type="text" id="status-search" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢..." onkeyup="renderStatusList()">
            <div id="status-book-list" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="tab-bookshelf" class="page">
        <h2>æœ¬æ£š</h2>
        <div style="overflow-x:auto; white-space:nowrap; padding-bottom:10px; margin-bottom:10px;" class="flex">
            <button id="filter-reading" class="filter-btn active" onclick="renderBookshelf('reading')">èª­æ›¸ä¸­</button>
            <button id="filter-all" class="filter-btn" onclick="renderBookshelf('all')">ã™ã¹ã¦</button>
            <button id="filter-unread" class="filter-btn" onclick="renderBookshelf('unread')">æœªèª­</button>
            <button id="filter-completed" class="filter-btn" onclick="renderBookshelf('completed')">èª­äº†</button>
            <button id="filter-dropped" class="filter-btn" onclick="renderBookshelf('dropped')">é›¢è„±</button>
        </div>
        <div id="bookshelf-list" class="card" style="min-height:200px"></div>
    </div>

    <div id="edit-screen" class="page">
        <button class="secondary" onclick="closeEditScreen()" style="width:auto; margin-bottom:15px;">â† æˆ»ã‚‹</button>
        <h2>è©³ç´°ç·¨é›†</h2>
        <div class="card">
            <input type="hidden" id="edit-id">
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="edit-title">
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="edit-status">
                <option value="unread">æœªèª­</option>
                <option value="reading">èª­æ›¸ä¸­</option>
                <option value="completed">èª­äº†</option>
                <option value="dropped">é›¢è„±ä¸­</option>
            </select>
            <div class="flex">
                <div style="flex:1">
                    <label>é–‹å§‹æ—¥</label>
                    <input type="date" id="edit-start-date">
                </div>
                <div style="flex:1">
                    <label>çµ‚äº†æ—¥</label>
                    <input type="date" id="edit-finish-date">
                </div>
            </div>
            <label>æœ€æ–°ã®åˆ°é”ãƒšãƒ¼ã‚¸ (è¨˜éŒ²ã‚’è¿½åŠ )</label>
            <input type="number" id="edit-current-page">
            <h3 style="margin-top:20px;">èª­æ›¸ãƒ¡ãƒ¢å±¥æ­´</h3>
            <div id="edit-memo-history" class="memo-history"></div>
            <button onclick="saveEdit()" style="margin-top:20px;">å¤‰æ›´ã‚’ä¿å­˜</button>
            <button class="danger" onclick="deleteBook()">å‰Šé™¤ã™ã‚‹</button>
        </div>
    </div>

    <div id="tab-calendar" class="page">
        <h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div class="card" style="padding:10px;">
            <div class="calendar-header">
                <button class="secondary" style="width:40px; margin:0;" onclick="changeMonth(-1)">â€¹</button>
                <span id="calendar-title" class="calendar-month-title"></span>
                <button class="secondary" style="width:40px; margin:0;" onclick="changeMonth(1)">â€º</button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    </div>

    <div id="tab-stats" class="page">
        <h2>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</h2>
        <div class="card">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div>
                    <h3 style="font-size:0.8rem; margin-bottom:0;">èª­äº†å†Šæ•°</h3>
                    <span id="stat-total-completed" style="font-size:1.5rem; font-weight:bold; color:var(--primary-color);">0</span> å†Š
                </div>
                <div>
                    <h3 style="font-size:0.8rem; margin-bottom:0;">ç´¯è¨ˆãƒšãƒ¼ã‚¸</h3>
                    <span id="stat-total-pages" style="font-size:1.5rem; font-weight:bold; color:var(--text-main);">0</span> p
                </div>
                <div>
                    <h3 style="font-size:0.8rem; margin-bottom:0;">1æ—¥å¹³å‡</h3>
                    <span id="stat-avg-daily-page" style="font-size:1.2rem; font-weight:bold;">0</span> p
                </div>
                <div>
                    <h3 style="font-size:0.8rem; margin-bottom:0;">1å†Šå¹³å‡</h3>
                    <span id="stat-avg-days-book" style="font-size:1.2rem; font-weight:bold;">0</span> æ—¥
                </div>
            </div>
        </div>
        <div class="card">
            <h3>æœˆåˆ¥èª­äº†æ•°</h3>
            <canvas id="chart-monthly-books-completed"></canvas>
        </div>
        <div class="card">
            <h3>æ—¥åˆ¥ãƒšãƒ¼ã‚¸æ•° (ç›´è¿‘7æ—¥)</h3>
            <canvas id="chart-daily-pages"></canvas>
        </div>
        <div class="card">
            <h3>é€±åˆ¥ãƒšãƒ¼ã‚¸æ•°æ¨ç§»</h3>
            <canvas id="chart-weekly-pages"></canvas>
        </div>
        <div class="card">
            <h3>æœˆåˆ¥ãƒšãƒ¼ã‚¸æ•°æ¨ç§»</h3>
            <canvas id="chart-monthly-pages"></canvas>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('record')"><span class="nav-icon">âœ</span> è¨˜éŒ²</div>
        <div class="nav-item" onclick="switchTab('bookshelf')"><span class="nav-icon">ğŸ“š</span> æœ¬æ£š</div>
        <div class="nav-item" onclick="switchTab('calendar')"><span class="nav-icon">ğŸ“…</span> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
        <div class="nav-item" onclick="switchTab('stats')"><span class="nav-icon">ğŸ“Š</span> çµ±è¨ˆ</div>
    </div>

    <script>
        // --- Data & Initialization ---
        let books = JSON.parse(localStorage.getItem('readingApp_books')) || [];
        let currentCalendarDate = new Date();

        const colorPalette = [
            '#fca5a5', '#fdba74', '#fde047', '#86efac', '#67e8f9', 
            '#93c5fd', '#c4b5fd', '#f0abfc', '#f9a8d4', '#cbd5e1'
        ];
        
        function getBookColor(id) {
            return colorPalette[id % colorPalette.length];
        }

        function saveData() {
            localStorage.setItem('readingApp_books', JSON.stringify(books));
        }

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';

        // --- Tab Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const map = { record:0, bookshelf:1, calendar:2, stats:3 };
            if(map[tabName] !== undefined) document.querySelectorAll('.nav-item')[map[tabName]].classList.add('active');

            if(tabName === 'record') resetRecordForms();
            if(tabName === 'bookshelf') renderBookshelf('reading'); // Default to reading
            if(tabName === 'calendar') renderCalendar();
            if(tabName === 'stats') renderStats();
            
            window.scrollTo(0,0);
        }

        // --- Record Logic ---
        function showRecordSection(section) {
            ['add-new','log-reading','change-status'].forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
            });
            document.getElementById(`section-${section}`).classList.remove('hidden');
            if(section === 'log-reading') populateLogSelect();
            if(section === 'change-status') renderStatusList();
        }

        function resetRecordForms() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-log-date').value = today;
            document.getElementById('log-date').value = today;
        }

        // --- Core Data Functions ---
        function addNewBook() {
            const title = document.getElementById('new-title').value;
            if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            const startDate = document.getElementById('new-start-date').value;
            const logDate = document.getElementById('new-log-date').value;
            const page = parseInt(document.getElementById('new-page').value) || 0;
            const finishDate = document.getElementById('new-finish-date').value;
            const memo = document.getElementById('new-memo').value;

            const newBook = {
                id: Date.now(),
                title: title,
                status: 'unread',
                startDate: startDate || '',
                finishDate: finishDate || '',
                logs: []
            };

            if(logDate || page > 0) {
                if(!newBook.startDate && logDate) newBook.startDate = logDate;
                newBook.status = 'reading';
                if(finishDate) newBook.status = 'completed';
                newBook.logs.push({ date: logDate || new Date().toISOString().split('T')[0], page: page, memo: memo });
            }

            books.push(newBook);
            saveData();
            alert("ã€Œ" + title + "ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ");
            
            document.getElementById('new-title').value = '';
            document.getElementById('new-page').value = '';
            document.getElementById('new-memo').value = '';
            showRecordSection('log-reading');
        }

        function addLog() {
            const bookId = document.getElementById('log-book-select').value;
            if(!bookId) return alert("æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            const date = document.getElementById('log-date').value;
            const page = parseInt(document.getElementById('log-page').value);
            const memo = document.getElementById('log-memo').value;

            if(!date || isNaN(page)) return alert("æ—¥ä»˜ã¨ãƒšãƒ¼ã‚¸æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            const book = books.find(b => b.id == bookId);
            const lastPage = book.logs.length > 0 ? book.logs[book.logs.length-1].page : 0;
            
            if(page < lastPage) return alert(`ãƒšãƒ¼ã‚¸æ•°ãŒæ¸›ã£ã¦ã„ã¾ã™ï¼ˆç¾åœ¨: ${lastPage}pï¼‰`);

            if(book.status === 'unread') {
                book.status = 'reading';
                if(!book.startDate) book.startDate = date;
            }

            book.logs.push({ date, page, memo });
            book.logs.sort((a,b) => new Date(a.date) - new Date(b.date));
            saveData();
            alert("è¨˜éŒ²ã—ã¾ã—ãŸ");
            document.getElementById('log-memo').value = '';
            document.getElementById('log-page').value = '';
            updateCurrentPageDisplay();
        }

        function populateLogSelect() {
            const select = document.getElementById('log-book-select');
            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            const targets = books.filter(b => b.status === 'unread' || b.status === 'reading');
            targets.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = b.title;
                select.appendChild(opt);
            });
        }

        function updateCurrentPageDisplay() {
            const id = document.getElementById('log-book-select').value;
            const disp = document.getElementById('current-page-display');
            if(!id) { disp.innerText = "ç¾åœ¨: - ãƒšãƒ¼ã‚¸"; return; }
            const b = books.find(x => x.id == id);
            const p = b.logs.length ? b.logs[b.logs.length-1].page : 0;
            disp.innerText = `ç¾åœ¨: ${p} ãƒšãƒ¼ã‚¸`;
        }
        
        function finishBookFromLog() {
            const id = document.getElementById('log-book-select').value;
            if(!id) return alert("æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„");
            const date = document.getElementById('log-date').value || new Date().toISOString().split('T')[0];
            const b = books.find(x => x.id == id);
            b.status = 'completed';
            b.finishDate = date;
            saveData();
            alert("èª­äº†ã«è¨­å®šã—ã¾ã—ãŸï¼");
            populateLogSelect();
        }
        
        function dropBookFromLog() {
            const id = document.getElementById('log-book-select').value;
            if(!id) return alert("æœ¬ã‚’é¸æŠã—ã¦ãã ã•ã„");
            const b = books.find(x => x.id == id);
            b.status = 'dropped';
            saveData();
            alert("é›¢è„±ã«è¨­å®šã—ã¾ã—ãŸ");
            populateLogSelect();
        }

        // --- Lists & Search ---
        function renderStatusList() {
            const list = document.getElementById('status-book-list');
            const q = document.getElementById('status-search').value.toLowerCase();
            list.innerHTML = '';
            const hits = books.filter(b => b.title.toLowerCase().includes(q));
            hits.forEach(b => {
                const item = document.createElement('div');
                item.className = 'book-item';
                item.innerHTML = `
                    <div class="book-info">
                        <span class="book-title">${b.title} <span class="status-badge status-${b.status}">${getStatusLabel(b.status)}</span></span>
                    </div>
                    <button class="secondary" style="width:auto; margin:0; padding:6px 12px; font-size:12px;" onclick="openEditScreen(${b.id})">ç·¨é›†</button>
                `;
                list.appendChild(item);
            });
        }

        // --- Bookshelf Render (with UI Active State) ---
        function renderBookshelf(filter) {
            // 1. UI Active State
            const ids = ['filter-reading', 'filter-all', 'filter-unread', 'filter-completed', 'filter-dropped'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(id === `filter-${filter}`) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });

            // 2. Render List
            const list = document.getElementById('bookshelf-list');
            list.innerHTML = '';
            let targets = (filter === 'all') ? books : books.filter(b => b.status === filter);
            
            if(targets.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub);">æœ¬ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            targets.forEach(b => {
                const item = document.createElement('div');
                item.className = 'book-item';
                item.innerHTML = `
                    <div class="book-info">
                        <span class="book-title">${b.title} <span class="status-badge status-${b.status}">${getStatusLabel(b.status)}</span></span>
                        <div class="text-small">é–‹å§‹: ${b.startDate||'-'} / çµ‚äº†: ${b.finishDate||'-'}</div>
                    </div>
                    <button class="secondary" style="width:auto; margin:0;" onclick="openEditScreen(${b.id})">è©³ç´°</button>
                `;
                list.appendChild(item);
            });
        }

        function getStatusLabel(s) {
            const map = { unread:'æœªèª­', reading:'èª­æ›¸ä¸­', completed:'èª­äº†', dropped:'é›¢è„±' };
            return map[s] || s;
        }

        // --- Edit Screen ---
        function openEditScreen(id) {
            const b = books.find(x => x.id == id);
            if(!b) return;
            document.getElementById('edit-id').value = b.id;
            document.getElementById('edit-title').value = b.title;
            document.getElementById('edit-status').value = b.status;
            document.getElementById('edit-start-date').value = b.startDate;
            document.getElementById('edit-finish-date').value = b.finishDate;
            
            const currP = b.logs.length ? b.logs[b.logs.length-1].page : 0;
            document.getElementById('edit-current-page').value = currP;

            const hist = document.getElementById('edit-memo-history');
            hist.innerHTML = '';
            [...b.logs].sort((x,y) => new Date(y.date)-new Date(x.date)).forEach(l => {
                const d = document.createElement('div');
                d.className = 'memo-item';
                d.innerHTML = `<span style="color:var(--primary-color); font-weight:bold;">${l.date}</span> (${l.page}p) ${l.memo ? '<br>'+l.memo : ''}`;
                hist.appendChild(d);
            });

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('edit-screen').classList.add('active');
        }

        function closeEditScreen() {
            document.getElementById('edit-screen').classList.remove('active');
            switchTab('bookshelf');
        }

        function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const b = books.find(x => x.id == id);
            b.title = document.getElementById('edit-title').value;
            b.status = document.getElementById('edit-status').value;
            b.startDate = document.getElementById('edit-start-date').value;
            b.finishDate = document.getElementById('edit-finish-date').value;
            
            const inpP = parseInt(document.getElementById('edit-current-page').value);
            const lastLog = b.logs.length ? b.logs[b.logs.length-1] : null;
            if(!lastLog || lastLog.page !== inpP) {
                b.logs.push({ date: new Date().toISOString().split('T')[0], page: inpP, memo: 'ç·¨é›†ç”»é¢æ›´æ–°' });
                b.logs.sort((x,y) => new Date(x.date)-new Date(y.date));
            }
            saveData();
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            closeEditScreen();
        }

        function deleteBook() {
            if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const id = document.getElementById('edit-id').value;
            books = books.filter(b => b.id != id);
            saveData();
            closeEditScreen();
        }

        // --- Calendar Logic (Fixed & Continuous) ---
        function changeMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendar-title').innerText = `${year}å¹´ ${month+1}æœˆ`;
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
                const div = document.createElement('div');
                div.className = 'calendar-day-header';
                div.innerText = d;
                grid.appendChild(div);
            });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month+1, 0);
            const startDayIdx = firstDay.getDay(); 
            const totalDays = lastDay.getDate();

            let daysArray = [];
            for(let i=0; i<startDayIdx; i++) daysArray.push(null);
            for(let i=1; i<=totalDays; i++) daysArray.push(new Date(year, month, i));

            for(let i=0; i<daysArray.length; i+=7) {
                const weekDays = daysArray.slice(i, i+7);
                let activeBooksInWeek = new Set();
                let weekStart = null;

                weekDays.forEach(d => {
                    if(d) {
                        if(!weekStart) weekStart = d;
                        books.forEach(b => {
                            if(b.status === 'dropped' || !b.startDate) return;
                            const s = new Date(b.startDate); s.setHours(0,0,0,0);
                            let e = b.finishDate ? new Date(b.finishDate) : new Date(); e.setHours(0,0,0,0);
                            const curr = d; curr.setHours(0,0,0,0);
                            if(curr >= s && curr <= e) activeBooksInWeek.add(b);
                        });
                    }
                });

                const sortedWeekBooks = Array.from(activeBooksInWeek).sort((a,b) => {
                    const sa = new Date(a.startDate);
                    const sb = new Date(b.startDate);
                    return sa - sb || a.id - b.id; 
                });

                const bookSlotMap = {};
                sortedWeekBooks.forEach((b, idx) => bookSlotMap[b.id] = idx);

                for(let j=0; j<7; j++) {
                    const cellDate = weekDays[j];
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell';
                    
                    if(!cellDate) {
                        cell.style.background = 'transparent';
                    } else {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const dateStr = cellDate.toISOString().split('T')[0];
                        if(dateStr === todayStr) cell.classList.add('today');
                        
                        cell.innerHTML = `<span class="day-number">${cellDate.getDate()}</span>`;
                        
                        const dayStart = new Date(cellDate); dayStart.setHours(0,0,0,0);
                        const todaysBooks = sortedWeekBooks.filter(b => {
                            const s = new Date(b.startDate); s.setHours(0,0,0,0);
                            let e = b.finishDate ? new Date(b.finishDate) : new Date(); e.setHours(0,0,0,0);
                            return dayStart >= s && dayStart <= e;
                        });

                        todaysBooks.forEach(b => {
                            const slotIndex = bookSlotMap[b.id];
                            const topPos = 20 + (slotIndex * 18);
                            
                            const bar = document.createElement('div');
                            bar.className = 'event-bar';
                            bar.style.top = `${topPos}px`;
                            bar.style.backgroundColor = getBookColor(b.id);
                            
                            const s = new Date(b.startDate); s.setHours(0,0,0,0);
                            let e = b.finishDate ? new Date(b.finishDate) : new Date(); e.setHours(0,0,0,0);

                            if(j===0 || dayStart.getTime() === s.getTime()) {
                                bar.innerText = b.title;
                            } else {
                                bar.innerHTML = '&nbsp;';
                            }

                            // CONTINUITY LOGIC:
                            // Only round corners on the actual Start and End dates of the book.
                            // Middle days get 0 radius and 0 margin (handled by CSS default).
                            
                            if(dayStart.getTime() === s.getTime()) {
                                bar.style.borderTopLeftRadius = '4px';
                                bar.style.borderBottomLeftRadius = '4px';
                                bar.style.marginLeft = '2px';
                                bar.style.width = 'calc(100% - 2px)';
                            }
                            if(dayStart.getTime() === e.getTime()) {
                                bar.style.borderTopRightRadius = '4px';
                                bar.style.borderBottomRightRadius = '4px';
                                bar.style.marginRight = '2px';
                                // Adjust width if it was also a start date
                                if(dayStart.getTime() === s.getTime()) {
                                    bar.style.width = 'calc(100% - 4px)';
                                } else {
                                    bar.style.width = 'calc(100% - 2px)';
                                }
                            }

                            cell.appendChild(bar);
                        });
                    }
                    grid.appendChild(cell);
                }
            }
        }

        // --- Statistics Logic (Charts) ---
        let charts = {};

        function renderStats() {
            const completed = books.filter(b => b.status === 'completed');
            
            let totalP = 0;
            books.forEach(b => { if(b.logs.length) totalP += Math.max(...b.logs.map(l=>l.page)); });
            
            let allDates = [];
            books.forEach(b => b.logs.forEach(l => allDates.push(new Date(l.date))));
            let avgDaily = 0;
            if(allDates.length) {
                const minD = new Date(Math.min.apply(null, allDates));
                const diff = Math.max(1, Math.ceil((new Date()-minD)/86400000));
                avgDaily = Math.round(totalP / diff);
            }

            let totalDaysBook = 0;
            completed.forEach(b => {
                const s = new Date(b.startDate); const e = new Date(b.finishDate);
                totalDaysBook += Math.max(1, Math.ceil((e-s)/86400000)+1);
            });
            const avgBook = completed.length ? Math.round(totalDaysBook/completed.length) : 0;

            document.getElementById('stat-total-completed').innerText = completed.length;
            document.getElementById('stat-total-pages').innerText = totalP;
            document.getElementById('stat-avg-daily-page').innerText = avgDaily;
            document.getElementById('stat-avg-days-book').innerText = avgBook;

            let dailyMap = {};
            books.forEach(b => {
                let sLogs = [...b.logs].sort((x,y) => new Date(x.date)-new Date(y.date));
                sLogs.forEach((l,i) => {
                    const prev = i>0 ? sLogs[i-1].page : 0;
                    const d = l.page - prev;
                    if(d>0) dailyMap[l.date] = (dailyMap[l.date]||0) + d;
                });
            });

            const mComp = {};
            completed.forEach(b => {
                if(b.finishDate) mComp[b.finishDate.slice(0,7)] = (mComp[b.finishDate.slice(0,7)]||0)+1;
            });
            drawChart('chart-monthly-books-completed', 'line', mComp, 'èª­äº†å†Šæ•°', '#22c55e');

            const dailyLast7 = {};
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                const k = d.toISOString().split('T')[0];
                dailyLast7[k.slice(5)] = dailyMap[k]||0;
            }
            drawChartRaw('chart-daily-pages', 'bar', Object.keys(dailyLast7), Object.values(dailyLast7), 'ãƒšãƒ¼ã‚¸æ•°', '#38bdf8');

            const weekMap = {};
            Object.keys(dailyMap).sort().forEach(k => {
                const d = new Date(k);
                const day = d.getDay()||7; 
                if(day!==1) d.setHours(-24*(day-1));
                const wKey = d.toISOString().split('T')[0];
                weekMap[wKey] = (weekMap[wKey]||0) + dailyMap[k];
            });
            drawChart('chart-weekly-pages', 'line', weekMap, 'é€±é–“ãƒšãƒ¼ã‚¸', '#818cf8');

            const monthP = {};
            Object.keys(dailyMap).forEach(k => {
                monthP[k.slice(0,7)] = (monthP[k.slice(0,7)]||0) + dailyMap[k];
            });
            drawChart('chart-monthly-pages', 'bar', monthP, 'æœˆé–“ãƒšãƒ¼ã‚¸', '#f472b6');
        }

        function drawChart(id, type, dataObj, label, color) {
            const keys = Object.keys(dataObj).sort();
            const useKeys = keys.slice(-12);
            const useVals = useKeys.map(k => dataObj[k]);
            drawChartRaw(id, type, useKeys, useVals, label, color);
        }

        function drawChartRaw(id, type, labels, data, label, color) {
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            
            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        tension: 0.3,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#334155' } },
                        x: { grid: { display: false } }
                    }
                }
            };
            if(type==='line') config.data.datasets[0].backgroundColor = color+'20';
            if(type==='line') config.data.datasets[0].fill = true;
            
            charts[id] = new Chart(ctx, config);
        }

        // Init
        resetRecordForms();
        populateLogSelect();
        // Default Bookshelf view
        renderBookshelf('reading');
    </script>
</body>
</html>
